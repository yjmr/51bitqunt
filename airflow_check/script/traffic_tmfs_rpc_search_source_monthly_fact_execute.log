,b.Id as row_id
,b.SkuName as  sku_name
,b.TrafficSource as traffic_source_name
,b.terminal as terminal_name
,b.Source as source_name
,b.ShopID as original_store_id
,b.Local_modified as local_update_time
,from_unixtime(unix_timestamp()+28800,'yyyyMMddHHmmss')       as    dw_batch_num
,from_unixtime(unix_timestamp()+28800,'yyyy-MM-dd HH:mm:ss')  as    dw_create_time
,from_unixtime(unix_timestamp()+28800,'yyyy-MM-dd HH:mm:ss')  as    dw_last_update_time
,'Tmall FS' as dw_source_sys
,'stg.top_sycm_sourcedetails' as dw_source_table
from
(select  a.*,map.store_nskey,map.cust_id,map.store_id from
(select *,
row_number() over(partition by
Id  order by Local_modified desc,dw_create_time desc) numa
from stg.top_sycm_sourcedetails) a
--left join dk_hub.tb_gtm_store_dim_map map on a.ShopId=map.original_store_id
left join dk_hub.tb_gtm_store_dim_map map on
( case when a.shopid='1' then '2017001'
       when a.shopid='2' then '2017005'
       when a.shopid='3' then '2017003'
       when a.shopid='4' then '2017006'
       when a.shopid='5' then '2017009'
       when a.shopid='6' then '2017004'
       when a.shopid='7' then '2017002'
       when a.shopid='8' then '2017007'
       when a.shopid='9' then '2017008'
       when a.shopid='19' then '2017019'
       when a.shopid='21' then '2017021'
       when a.shopid='22' then '2017022'
       when a.shopid='24' then '2017024'
       when a.shopid='25' then '2017025'
       end )=map.store_id
where a.numa=1 and  a.dw_create_time >='2019-12-01 11:22:22'
) b
left join dk_hub.tb_gtm_epos_product_rpc_dk_map c on
b.store_nskey=c.store_nskey and  b.NumID=c.rpc_code
union all
select * from dwd.tb_bb_etraf_tmfs_rpc_search_source_monthly_fact) as d ) e where e.numaa = 1

2019-12-02 05:03:27,814 - pub_module - INFO - ETL结束时间：2019-12-02 13:03:27
2019-12-03 04:32:02,979 - pub_module - INFO - ---- IngestLogFile is not empty -----
2019-12-03 04:32:02,980 - pub_module - INFO - select
e.trans_month
,e.cust_product_nskey
,e.store_nskey
,e.cust_id
,e.store_id
,e.rpc_code
,e.uv
,e.row_id
,e.sku_name
,e.traffic_source_name
,e.terminal_name
,e.source_name
,e.original_store_id
,e.local_update_time
,e.dw_batch_num
,e.dw_create_time
,e.dw_last_update_time
,e.dw_source_sys
,e.dw_source_table
from
(select d.*,row_number() over(partition by d.row_id order by d.dw_create_time desc) numaa
from
(select
b.DataDate as trans_month
,nvl(c.cust_product_nskey,'-999998') as cust_product_nskey
,b.store_nskey
,b.cust_id
,b.store_id
,b.NumID as rpc_code
,b.uv as uv
,b.Id as row_id
,b.SkuName as  sku_name
,b.TrafficSource as traffic_source_name
,b.terminal as terminal_name
,b.Source as source_name
,b.ShopID as original_store_id
,b.Local_modified as local_update_time
,from_unixtime(unix_timestamp()+28800,'yyyyMMddHHmmss')       as    dw_batch_num
,from_unixtime(unix_timestamp()+28800,'yyyy-MM-dd HH:mm:ss')  as    dw_create_time
,from_unixtime(unix_timestamp()+28800,'yyyy-MM-dd HH:mm:ss')  as    dw_last_update_time
,'Tmall FS' as dw_source_sys
,'stg.top_sycm_sourcedetails' as dw_source_table
from
(select  a.*,map.store_nskey,map.cust_id,map.store_id from
(select *,
row_number() over(partition by
Id  order by Local_modified desc,dw_create_time desc) numa
from stg.top_sycm_sourcedetails) a
--left join dk_hub.tb_gtm_store_dim_map map on a.ShopId=map.original_store_id
left join dk_hub.tb_gtm_store_dim_map map on
( case when a.shopid='1' then '2017001'
       when a.shopid='2' then '2017005'
       when a.shopid='3' then '2017003'
       when a.shopid='4' then '2017006'
       when a.shopid='5' then '2017009'
       when a.shopid='6' then '2017004'
       when a.shopid='7' then '2017002'
       when a.shopid='8' then '2017007'
       when a.shopid='9' then '2017008'
       when a.shopid='19' then '2017019'
       when a.shopid='21' then '2017021'
       when a.shopid='22' then '2017022'
       when a.shopid='24' then '2017024'
       when a.shopid='25' then '2017025'
       end )=map.store_id
where a.numa=1 and  a.dw_create_time >='2019-12-02 12:59:39'
) b
left join dk_hub.tb_gtm_epos_product_rpc_dk_map c on
b.store_nskey=c.store_nskey and  b.NumID=c.rpc_code
union all
select * from dwd.tb_bb_etraf_tmfs_rpc_search_source_monthly_fact) as d ) e where e.numaa = 1

2019-12-03 04:37:57,298 - pub_module - INFO - ETL结束时间：2019-12-03 12:37:57
2019-12-04 07:13:26,794 - pub_module - INFO - ---- IngestLogFile is not empty -----
2019-12-04 07:13:26,795 - pub_module - INFO - select
e.trans_month
,e.cust_product_nskey
,e.store_nskey
,e.cust_id
,e.store_id
,e.rpc_code
,e.uv
,e.row_id
,e.sku_name
,e.traffic_source_name
,e.terminal_name
,e.source_name
,e.original_store_id
,e.local_update_time
,e.dw_batch_num
,e.dw_create_time
,e.dw_last_update_time
,e.dw_source_sys
,e.dw_source_table
from
(select d.*,row_number() over(partition by d.row_id order by d.dw_create_time desc) numaa
from
(select
b.DataDate as trans_month
,nvl(c.cust_product_nskey,'-999998') as cust_product_nskey
,b.store_nskey
,b.cust_id
,b.store_id
,b.NumID as rpc_code
,b.uv as uv
,b.Id as row_id
,b.SkuName as  sku_name
,b.TrafficSource as traffic_source_name
,b.terminal as terminal_name
,b.Source as source_name
,b.ShopID as original_store_id
,b.Local_modified as local_update_time
,from_unixtime(unix_timestamp()+28800,'yyyyMMddHHmmss')       as    dw_batch_num
,from_unixtime(unix_timestamp()+28800,'yyyy-MM-dd HH:mm:ss')  as    dw_create_time
,from_unixtime(unix_timestamp()+28800,'yyyy-MM-dd HH:mm:ss')  as    dw_last_update_time
,'Tmall FS' as dw_source_sys
,'stg.top_sycm_sourcedetails' as dw_source_table
from
(select  a.*,map.store_nskey,map.cust_id,map.store_id from
(select *,
row_number() over(partition by
Id  order by Local_modified desc,dw_create_time desc) numa
from stg.top_sycm_sourcedetails) a
--left join dk_hub.tb_gtm_store_dim_map map on a.ShopId=map.original_store_id
left join dk_hub.tb_gtm_store_dim_map map on
( case when a.shopid='1' then '2017001'
       when a.shopid='2' then '2017005'
       when a.shopid='3' then '2017003'
       when a.shopid='4' then '2017006'
       when a.shopid='5' then '2017009'
       when a.shopid='6' then '2017004'
       when a.shopid='7' then '2017002'
       when a.shopid='8' then '2017007'
       when a.shopid='9' then '2017008'
       when a.shopid='19' then '2017019'
       when a.shopid='21' then '2017021'
       when a.shopid='22' then '2017022'
       when a.shopid='24' then '2017024'
       when a.shopid='25' then '2017025'
       end )=map.store_id
where a.numa=1 and  a.dw_create_time >='2019-12-03 12:32:02'
) b
left join dk_hub.tb_gtm_epos_product_rpc_dk_map c on
b.store_nskey=c.store_nskey and  b.NumID=c.rpc_code
union all
select * from dwd.tb_bb_etraf_tmfs_rpc_search_source_monthly_fact) as d ) e where e.numaa = 1

2019-12-04 07:19:55,549 - pub_module - INFO - ETL结束时间：2019-12-04 15:19:55
2019-12-05 03:26:02,545 - pub_module - INFO - ---- IngestLogFile is not empty -----
2019-12-05 03:26:02,547 - pub_module - INFO - select
e.trans_month
,e.cust_product_nskey
,e.store_nskey
,e.cust_id
,e.store_id
,e.rpc_code
,e.uv
,e.row_id
,e.sku_name
,e.traffic_source_name
,e.terminal_name
,e.source_name
,e.original_store_id
,e.local_update_time
,e.dw_batch_num
,e.dw_create_time
,e.dw_last_update_time
,e.dw_source_sys
,e.dw_source_table
from
(select d.*,row_number() over(partition by d.row_id order by d.dw_create_time desc) numaa
from
(select
b.DataDate as trans_month
,nvl(c.cust_product_nskey,'-999998') as cust_product_nskey
,b.store_nskey
,b.cust_id
,b.store_id
,b.NumID as rpc_code
,b.uv as uv
,b.Id as row_id
,b.SkuName as  sku_name
,b.TrafficSource as traffic_source_name
,b.terminal as terminal_name
,b.Source as source_name
,b.ShopID as original_store_id
,b.Local_modified as local_update_time
,from_unixtime(unix_timestamp()+28800,'yyyyMMddHHmmss')       as    dw_batch_num
,from_unixtime(unix_timestamp()+28800,'yyyy-MM-dd HH:mm:ss')  as    dw_create_time
,from_unixtime(unix_timestamp()+28800,'yyyy-MM-dd HH:mm:ss')  as    dw_last_update_time
,'Tmall FS' as dw_source_sys
,'stg.top_sycm_sourcedetails' as dw_source_table
from
(select  a.*,map.store_nskey,map.cust_id,map.store_id from
(select *,
row_number() over(partition by
Id  order by Local_modified desc,dw_create_time desc) numa
from stg.top_sycm_sourcedetails) a
--left join dk_hub.tb_gtm_store_dim_map map on a.ShopId=map.original_store_id
left join dk_hub.tb_gtm_store_dim_map map on
( case when a.shopid='1' then '2017001'
       when a.shopid='2' then '2017005'
       when a.shopid='3' then '2017003'
       when a.shopid='4' then '2017006'
       when a.shopid='5' then '2017009'
       when a.shopid='6' then '2017004'
       when a.shopid='7' then '2017002'
       when a.shopid='8' then '2017007'
       when a.shopid='9' then '2017008'
       when a.shopid='19' then '2017019'
       when a.shopid='21' then '2017021'
       when a.shopid='22' then '2017022'
       when a.shopid='24' then '2017024'
       when a.shopid='25' then '2017025'
       end )=map.store_id
where a.numa=1 and  a.dw_create_time >='2019-12-04 15:13:26'
) b
left join dk_hub.tb_gtm_epos_product_rpc_dk_map c on
b.store_nskey=c.store_nskey and  b.NumID=c.rpc_code
union all
select * from dwd.tb_bb_etraf_tmfs_rpc_search_source_monthly_fact) as d ) e where e.numaa = 1

2019-12-05 03:32:14,927 - pub_module - INFO - ETL结束时间：2019-12-05 11:32:14
